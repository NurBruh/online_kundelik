{% extends 'dashboard_base.html' %}
{% load static i18n %}

{% block dashboard_title %}{% trans "Күнделікті баға қосу" %}{% endblock %}

{% block extra_css %}
<style>
    .class-selector-card {
        background-color: #f8f9fa; /* Ашық сұр фон */
        border-left: 4px solid #0d6efd; /* Көк жолақ */
        border-radius: .375rem;
    }
    .form-label {
        font-weight: 500;
    }
</style>
{% endblock %}


{% block dashboard_content %}

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">{% trans "Күнделікті баға қосу" %}</h1>
    </div>

    {# --- БЛОК ВЫБОРА КЛАССА --- #}
    <div class="card shadow-sm mb-4 class-selector-card">
        <div class="card-body">
            <form method="get" action="" class="row g-3 align-items-center">
                <div class="col-md-6 col-lg-4">
                    <label for="classSelect" class="form-label">{% trans "Сыныпты таңдаңыз:" %}</label>
                    {# JavaScript арқылы GET сұрауын жіберу #}
                    <select class="form-select form-select-sm" id="classSelect" name="class_id" onchange="this.form.submit()">
                        <option value="">-- {% trans "Сынып" %} --</option>
                        {% for class_item in teacher_classes %}
                            <option value="{{ class_item.pk }}" {% if selected_class and selected_class.pk == class_item.pk %}selected{% endif %}>
                                {{ class_item.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                 {# Ағымдағы URL параметрлерін сақтау үшін #}
                 {% for key, value in request.GET.items %}
                    {% if key != 'class_id' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                 {% endfor %}
                <div class="col-auto">
                     {# Бұл батырма қажет емес, өйткені onchange қолданылады #}
                     {# <button type="submit" class="btn btn-secondary btn-sm">{% trans "Көрсету" %}</button> #}
                </div>
                 {% if not selected_class %}
                 <div class="col-12">
                     <small class="form-text text-muted">
                        {% trans "Баға қою үшін жоғарыдан сыныпты таңдаңыз." %}
                     </small>
                 </div>
                 {% endif %}
            </form>
        </div>
    </div>
    {# --- КОНЕЦ БЛОКА ВЫБОРА КЛАССА --- #}

    {# Django messages жүйесі хабарламаларды көрсетеді #}
    {# {% include 'includes/messages.html' %} #}

    {# Форманы тек 'show_form' True болғанда көрсету #}
    {% if show_form %}
        <div class="card shadow-sm mt-4">
             <div class="card-header py-3">
                <h5 class="mb-0">
                    {% blocktrans with class_name=selected_class.name %}Баға қою: {{ class_name }} сыныбы{% endblocktrans %}
                    <span class="badge bg-secondary rounded-pill ms-2">{{ students_count }} {% trans "оқушы" %}</span>
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="selected_class_id" value="{{ selected_class.pk }}">

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger" role="alert">
                            {% for error in form.non_field_errors %}<p class="mb-0">{{ error }}</p>{% endfor %}
                        </div>
                    {% endif %}

                    <div class="row">
                        {% for field in form %}
                            {% if not field.is_hidden %}
                                <div class="col-md-6 mb-3">
                                    <label for="{{ field.id_for_label }}" class="form-label">
                                        {{ field.label }}{% if field.field.required %}<span class="text-danger">*</span>{% endif %}
                                    </label>

                                    {# --- СТУДЕНТ ӨРІСІН ТЕКСЕРУ (ТҮЗЕТІЛГЕН) --- #}
                                    {% if field.name == 'student' %}
                                        {# students_count контекст айнымалысын пайдалану #}
                                        {% if students_count > 0 %}
                                            {{ field }} {# Стандартты Select көрсету #}
                                        {% else %}
                                            {# Егер view студент таппаса, бірақ show_form=True болса (бұл болмауы керек, бірақ қосымша тексеру) #}
                                            <select class="form-select is-invalid" disabled><option>{% trans "Оқушылар жоқ" %}</option></select>
                                            <div class="invalid-feedback d-block">{% trans "Бұл сыныпта оқушылар табылмады." %}</div>
                                        {% endif %}
                                    {# --- ТҮЗЕТУ СОҢЫ --- #}
                                    {% else %}
                                        {# Басқа өрістерді көрсету (стильдерді сақтай отырып) #}
                                        {% if field.field.widget.input_type == 'select' %}
                                            {{ field.as_widget }}
                                        {% elif field.field.widget.input_type == 'number' %}
                                             {{ field.as_widget }}
                                        {% elif field.field.widget.input_type == 'text' or field.field.widget.input_type == 'email' %}
                                            {{ field.as_widget }}
                                        {% elif field.name == 'date' %}
                                            <input type="date" name="{{ field.name }}" id="{{ field.id_for_label }}"
                                                   class="form-control {% if field.errors %}is-invalid{% endif %}"
                                                   value="{{ field.value|date:'Y-m-d'|default:'' }}" {% if field.field.required %}required{% endif %}>
                                        {% else %}
                                            {{ field }} {# Басқа жағдайлар үшін #}
                                        {% endif %}
                                    {% endif %}

                                    {% if field.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in field.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                    {% if field.help_text %}
                                        <div class="form-text">{{ field.help_text|safe }}</div>
                                    {% endif %}
                                </div>
                            {% else %}
                                {{ field }} {# Жасырын өрістерді көрсету #}
                            {% endif %}
                        {% endfor %}
                    </div>

                    <hr>

                    <div class="text-end mt-3">
                        {# Батырманы тек студенттер бар болса ғана активті ету #}
                        <button type="submit" class="btn btn-primary" {% if students_count == 0 %}disabled{% endif %}>
                            <i class="fas fa-star me-1"></i> {% trans "Бағаны қосу" %}
                        </button>
                         <a href="?class_id={{ selected_class.pk }}" class="btn btn-outline-secondary">{% trans "Тазарту" %}</a>
                    </div>
                </form>
            </div>
        </div>
    {# Егер форма көрсетілмесе, бірақ сынып таңдалса (мысалы, оқушы жоқ) #}
    {% elif selected_class and not show_form %}
         {# Хабарлама messages арқылы шығады, қосымша ештеңе қажет емес #}
         {# <div class="alert alert-warning">Осы сыныпта оқушылар табылмады.</div> #}
         <a href="{% url 'add_daily_grade' %}" class="btn btn-secondary mt-3">
             <i class="fas fa-arrow-left me-1"></i> {% trans "Басқа сынып таңдау" %}
         </a>
    {% endif %}

{% endblock %}