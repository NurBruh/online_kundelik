{% extends 'dashboard_base.html' %}
{% load static i18n %}

{% block dashboard_title %}{% trans "Бағалар" %}{% endblock %}

{% block dashboard_content %}
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap"> {# Обертка для заголовка и селектора #}
        <h1 class="page-title mb-0">{% trans "Бағалар" %}</h1> {# Убрал нижний марджин у заголовка #}

        {# --- ДОБАВЛЕН БЛОК ВЫБОРА ЧЕТВЕРТИ --- #}
        {% if available_terms %} {# Показываем выбор только если есть доступные четверти #}
        <div class="d-flex align-items-center">
            <label for="termSelect" class="form-label me-2 mb-0 fw-normal">{% trans "Тоқсан:" %}</label>
            <select class="form-select form-select-sm w-auto" id="termSelect" onchange="location = this.value;">
                {# Генерируем URL с параметром term для каждой опции #}
                {% url 'dashboard_grades' as base_grades_url %}
                {% for term_num in available_terms %}
                    <option value="{{ base_grades_url }}?term={{ term_num }}" {% if term_num == current_term %}selected{% endif %}>
                        {{ term_num }}-{% trans "тоқсан" %}
                    </option>
                {% endfor %}
                {# Можно добавить опцию для просмотра всех оценок, если нужно #}
                {# <option value="{{ base_grades_url }}">{% trans "Барлығы" %}</option> #}
            </select>
        </div>
        {% endif %}
        {# --- КОНЕЦ БЛОКА ВЫБОРА ЧЕТВЕРТИ --- #}
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center flex-wrap">
            <h6 class="m-0 font-weight-bold text-primary">
                {# Используем переменную current_term, которая теперь отражает выбранную четверть #}
                {% blocktrans with class_name=student_class_name|default:"Белгісіз" term=current_term|default:"Ағымдағы" %}
                {{ class_name }} сынып - {{ term }} тоқсан
                {% endblocktrans %}
            </h6>
            <a href="{% url 'dashboard_schedule' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> {% trans "Артқа" %} {# Ссылка ведет на расписание #}
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover grade-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">№</th>
                            <th style="width: 25%;">{% trans "Пән" %}</th>
                            <th>{% trans "Күнделікті бағалар (баға/күн)" %}</th>
                            <th style="width: 10%;">{% trans "БЖБ" %}</th>
                            <th style="width: 10%;">{% trans "ТЖБ" %}</th>
                            <th style="width: 10%;">{% trans "Тоқсан" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Цикл по предметам и оценкам (остается без изменений, т.к. view теперь передает объекты) #}
                        {% for grade_info in subject_grades %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td class="text-start align-middle">{{ grade_info.subject_name }}</td>
                            <td class="align-middle">
                                {% for grade_data in grade_info.daily_grades_list %}
                                    <span class="grade-badge
                                        {% with grade_val=grade_data.grade %}
                                        {% if grade_val == 5 %} grade-5
                                        {% elif grade_val == 4 %} grade-4
                                        {% elif grade_val == 3 %} grade-3
                                        {% elif grade_val == 2 %} grade-2
                                        {% else %} grade-default {% endif %}
                                        {% endwith %}"
                                        title="{{ grade_data.date|date:'d.m.Y' }}{% if grade_data.comment %}: {{ grade_data.comment }}{% endif %}">
                                        {{ grade_data.grade }} <small class="text-white-50">({{ grade_data.date|date:'d.m' }})</small>
                                    </span>
                                {% empty %}
                                    <span class="text-muted">-</span>
                                {% endfor %}
                            </td>
                            <td class="text-center align-middle" title="{% if grade_info.sor_max_grade %}{% trans 'Макс:' %} {{ grade_info.sor_max_grade }}{% endif %}{% if grade_info.sor_comment %}. {{ grade_info.sor_comment }}{% endif %}">
                                {{ grade_info.sor_grade|default:"-" }}
                            </td>
                             <td class="text-center align-middle" title="{% if grade_info.soch_max_grade %}{% trans 'Макс:' %} {{ grade_info.soch_max_grade }}{% endif %}{% if grade_info.soch_comment %}. {{ grade_info.soch_comment }}{% endif %}">
                                {{ grade_info.soch_grade|default:"-" }}
                            </td>
                            <td class="text-center align-middle"><b>{{ grade_info.term_grade|default:"-" }}</b></td>
                        </tr>
                        {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted py-4">{% trans "Таңдалған тоқсанға бағалар әлі енгізілмеген." %}</td> {# Уточнено сообщение #}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {# Подвал будет взят из dashboard_base.html #}
{% endblock %}