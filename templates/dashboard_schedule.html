{% extends 'dashboard_base.html' %} {# Наследуемся от базового шаблона дашборда #}
{% load static i18n %}

{# --- Переопределяем заголовок страницы --- #}
{% block dashboard_title %}SmartOqulyq - {% trans "Сабақ кестесі" %}{% endblock %}

{# --- Переопределяем основной контент дашборда --- #}
{% block dashboard_content %}

    {# Заголовок внутри основной области #}
    <h1 class="page-title">{% trans "Сабақ кестесі" %}</h1>

    {# Отображение имени ученика/пользователя (карточка вынесена для группировки) #}
    <div class="card shadow mb-4">
        {# Показываем имя, если это расписание конкретного пользователя #}
        {% if target_user %}
        <div class="card-header py-3">
             {# Используем target_user, который передан из view #}
             {# Отображаем роль, если передана #}
            <div class="student-name">
                {{ target_user.get_full_name|default:target_user.username }}
                {% if display_role %}<span class="badge bg-secondary ms-2">{{ display_role }}</span>{% endif %}
            </div>
        </div>
        {% endif %}

        <div class="card-body"> {# Оборачиваем навигацию и таблицу в card-body #}
            {# --- Навигация по датам --- #}
            <div class="date-navigation mb-4">
                 {# ВАЖНО: Замените '#' на реальные URL для навигации по датам #}
                 {# Например: href="?date={{ previous_week_date|date:'Y-m-d' }}" #}
                 <a href="#" class="btn btn-outline-secondary btn-sm"><i class="fas fa-arrow-left me-1"></i> {% trans "Алдыңғы апта" %}</a>
                 {# Отображаем диапазон дат из контекста #}
                 <div class="current-date">{{ view_date_start|date:"d M" }} - {{ view_date_end|date:"d M Y" }}</div>
                 {# Например: href="?date={{ next_week_date|date:'Y-m-d' }}" #}
                 <a href="#" class="btn btn-outline-secondary btn-sm">{% trans "Келесі апта" %} <i class="fas fa-arrow-right ms-1"></i></a>
            </div>

            {# --- Отображение расписания по дням --- #}
            {% if schedules_by_date %}
                {% for date, daily_schedules in schedules_by_date.items %}
                    {# Заголовок дня недели #}
                     <h3 class="h5 fw-bold mt-4 mb-3 border-bottom pb-2">
                        {{ date|date:"l, d F Y" }} {# Полный формат даты и дня недели #}
                    </h3>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th scope="col" class="text-center" style="width: 5%;">№</th>
                                    <th scope="col" style="width: 15%;">{% trans "Уақыт" %}</th> {# Уменьшил ширину #}
                                    <th scope="col" style="width: 25%;">{% trans "Пән" %} / {% trans "Тақырып" %}</th> {# Объединил #}
                                    <th scope="col" style="width: 35%;">{% trans "Үй тапсырма" %}</th> {# Увеличил ширину #}
                                    <th scope="col" class="text-center" style="width: 10%;">{% trans "Статус" %}</th>
                                    <th scope="col" style="width: 10%;">{% trans "Мұғалім" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lesson in daily_schedules %}
                                <tr>
                                    <td class="text-center align-middle">{{ lesson.lesson_number|default:forloop.counter }}</td>
                                    <td class="text-center align-middle">{{ lesson.time_start|time:"H:i"|default:"-" }} - {{ lesson.time_end|time:"H:i"|default:"" }}</td> {# Пример с start/end time #}
                                    <td class="align-middle fw-medium">
                                        {{ lesson.subject.name|default:"-" }}
                                        {# ПРОВЕРЬТЕ: Если у урока есть отдельное поле 'topic', используйте его #}
                                        {% if lesson.topic %}
                                           <br><small class="text-muted">{{ lesson.topic }}</small>
                                        {% endif %}
                                    </td>
                                    {# ПРОВЕРЬТЕ: Убедитесь, что 'lesson.task' содержит именно домашнее задание #}
                                    <td class="align-middle small">{{ lesson.task|default:"-" }}</td> {# Домашнее задание #}
                                    <td class="text-center align-middle">
                                        {# Статус урока с иконками (логика статусов может отличаться) #}
                                        {% with status_display=lesson.get_status_display|default:lesson.status %}
                                            {% if lesson.status == 'completed' or lesson.status == 'checked' %}
                                                <span class="text-success" title="{{ status_display }}"><i class="fas fa-check-circle"></i></span>
                                            {% elif lesson.status == 'not_completed' or lesson.status == 'missed' %}
                                                <span class="text-danger" title="{{ status_display }}"><i class="fas fa-times-circle"></i></span>
                                            {% elif lesson.status == 'assigned' or lesson.status == 'pending' %}
                                                 <span class="text-warning" title="{{ status_display }}"><i class="far fa-clock"></i></span> {# Пример для 'в процессе' #}
                                            {% else %}
                                                <span class="text-secondary" title="{{ status_display }}"><i class="far fa-circle"></i></span> {# Неизвестный или 'назначен' #}
                                            {% endif %}
                                        {% endwith %}
                                    </td>
                                     <td class="small text-muted align-middle">{{ lesson.teacher.get_full_name|default:"-" }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted p-3">{% trans "Бұл күнге сабақ жоқ." %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %} {# Конец цикла по дням #}
            {% else %}
                {# Сообщение, если на выбранную неделю нет расписания #}
                <div class="alert alert-light text-center mt-4">{% trans "Таңдалған кезеңге сабақ кестесі табылмады." %}</div>
            {% endif %} {# Конец проверки schedules_by_date #}

        </div> {# Конец card-body #}
    </div> {# Конец card #}

{% endblock %} {# Конец блока dashboard_content #}